{% extends "base.html" %}
{% block title %}Статистика по офферам{% endblock %}
{% block content %}
<div class="container">
    <h2 class="my-4 text-center">Статистика</h2>

    <!-- Фильтры и кнопки -->
    <form method="get" class="mb-4">
        <div class="row">
            <div class="col-md-3 mb-2">
                <label for="start_date" class="form-label">Дата от</label>
                <input type="date" id="start_date" name="start_date" class="form-control form-control-sm" value="{{ request.GET.start_date }}">
            </div>
            <div class="col-md-3 mb-2">
                <label for="end_date" class="form-label">Дата до</label>
                <input type="date" id="end_date" name="end_date" class="form-control form-control-sm" value="{{ request.GET.end_date }}">
            </div>
            <div class="col-md-3 mb-2">
                <label for="offer_id" class="form-label">Выберите оффер</label>
                <select id="offer_id" name="offer_id" class="form-select form-select-sm">
                    <option value="">Все офферы</option>
                    {% for offer in offers %}
                    <option value="{{ offer.offer.id }}" {% if offer.offer.id|stringformat:"s" == request.GET.offer_id %}selected{% endif %}>{{ offer.offer.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end mb-2">
                <button type="submit" class="btn btn-primary btn-sm w-100">Применить</button>
            </div>
            <div class="col-md-3 d-flex align-items-end mb-2">
                {% if request.GET.all_time %}
                    <a href="?" class="btn btn-secondary btn-sm w-100">По дням</a>
                {% else %}
                    <a href="?all_time=1" class="btn btn-secondary btn-sm w-100">За все время</a>
                {% endif %}
            </div>
        </div>
    </form>

    <!-- Таблица статистики -->
    <table class="table table-bordered">
        <thead class="thead-light">
            <tr>

                <th style="text-align: center">Параметр</th>
                <th style="text-align: center">Трафик</th>
                <th colspan="5" style="text-align: center">Конверсии</th>
                <th colspan="3" style="text-align: center">Коэффициенты</th>

            </tr>
        </thead>
        <tbody>
        <tr>
                {% if request.GET.all_time %}
                    <th>Оффер</th>
                {% else %}
                    <th>Дата</th>
                {% endif %}
                <th>Уники</th>
                <th>Новые</th>
                <th>Принято</th>
                <th>Отклонено</th>
                <th>Треш</th>
                <th>Дубль</th>
                <th>CR (%)</th>
                <th>EPC (₽)</th>
                <th>Approve (%)</th>
            </tr>
            {% for stat in offer_stats %}
            <tr>
                {% if request.GET.all_time %}
                    <td>
                        <a href="{% url 'webmaster_offer_detail' stat.offer_webmaster__offer__id %}">{{ stat.offer_webmaster__offer__name }}</a>
                    </td>
                {% else %}
                    <td>{{ stat.created_at__date|date:"d.m.Y" }}</td>
                {% endif %}
                <td>{{ stat.unique_leads }}</td>
                <td>{{ stat.new_leads }}</td>
                <td>{{ stat.approved_leads }}</td>
                <td>{{ stat.rejected_leads }}</td>
                <td>{{ stat.trash_leads }}</td>
                <td>{{ stat.duplicate_leads }}</td>
                <td>{{ stat.conversion_rate|floatformat:2 }}</td>
                <td>{{ stat.epc|floatformat:2 }}</td>
                <td>{{ stat.approve_percent|floatformat:2 }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <!-- Пагинация -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item"><a class="page-link" href="?page=1">&laquo;&laquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}">&laquo;</a></li>
            {% endif %}
            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
            {% endif %}
            {% endfor %}
            {% if page_obj.has_next %}
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}">&raquo;</a></li>
            <li class="page-item"><a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">&raquo;&raquo;</a></li>
            {% endif %}
        </ul>
    </nav>
</div>
{% endblock %}
